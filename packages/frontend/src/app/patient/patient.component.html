<div class="password-change">
  <mat-accordion class="example-headers-align">
    <mat-expansion-panel hideToggle>
      <mat-expansion-panel-header class="itemsInsideDiv">
        <mat-panel-title class="align"> Promeni lozinku </mat-panel-title>
        <mat-panel-description class="align">
          Kliknite da promenite
          <mat-icon class="key"> key </mat-icon>
        </mat-panel-description>
      </mat-expansion-panel-header>
      <form [formGroup]="passwordForm" (ngSubmit)="changeThePassword()">
        <div>
          <mat-form-field>
            <mat-label>Stara lozinka</mat-label>
            <input matInput type="password" formControlName="oldPassword" />
          </mat-form-field>
        </div>
        <div>
          <mat-form-field>
            <mat-label>Nova lozinka</mat-label>
            <input matInput type="password" formControlName="newPassword" />
          </mat-form-field>
        </div>
        <div>
          <mat-form-field>
            <mat-label>Ponovite novu lozinku</mat-label>
            <input matInput type="password" formControlName="confirmPassword" />
          </mat-form-field>
        </div>
        <mat-action-row>
          <button mat-button color="primary" type="submit">Promeni</button>
        </mat-action-row>
        <p *ngIf="error" class="error">
          {{ error }}
        </p>
        <p *ngIf="passwordChanged" class="passwordChanged">
          {{ passwordChanged }}
        </p>
      </form>
    </mat-expansion-panel>
  </mat-accordion>
</div>
<div class="menu">
  <mat-tab-group animationDuration="0ms" class="full-width-tabs">
    <mat-tab label="Profil">
      <div class="profile">
        <h2>Vaš Profil</h2>
        <div class="profile-picture" (mouseover)="showEditButton = true" (mouseout)="showEditButton = false">
          <div class="centralImg">
            <img class="profileImg" [src]="loggedInUser.profile_picture" alt="Profilna slika" />
          </div>
          <div>
            <mat-card *ngIf="showEditProfilePictureInput">
              <mat-card-content>
                <input type="file" (change)="handleProfilePictureChange($event)" class="file-input" />
              </mat-card-content>
            </mat-card>
          </div>
        </div>
        <div class="profile-details">
          <ng-container *ngIf="!editingProfile">
            <p><strong>Ime:</strong> {{ loggedInUser.first_name }}</p>
            <p><strong>Prezime:</strong> {{ loggedInUser.last_name }}</p>
            <p><strong>Adresa:</strong> {{ loggedInUser.address }}</p>
            <p><strong>E-mail adresa:</strong> {{ loggedInUser.email }}</p>
            <p><strong>Kontakt telefon:</strong> {{ loggedInUser.phone }}</p>
            <button mat-raised-button color="primary" (click)="startEditingProfile()">
              Ažuriraj Profil
            </button>
          </ng-container>
          <ng-container *ngIf="editingProfile">
            <form [formGroup]="profileForm">
              <div class="editFields">
                <mat-form-field>
                  <mat-label>Ime</mat-label>
                  <input matInput formControlName="first_name" />
                </mat-form-field>
              </div>
              <div class="editFields">
                <mat-form-field>
                  <mat-label>Prezime</mat-label>
                  <input matInput formControlName="last_name" />
                </mat-form-field>
              </div>
              <div class="editFields">
                <mat-form-field>
                  <mat-label>Adresa</mat-label>
                  <input matInput formControlName="address" />
                </mat-form-field>
              </div>
              <div class="editFields">
                <mat-form-field>
                  <mat-label>E-mail adresa</mat-label>
                  <input matInput formControlName="email" />
                </mat-form-field>
              </div>
              <div class="editFields">
                <mat-form-field>
                  <mat-label>Kontakt telefon</mat-label>
                  <input matInput formControlName="phone" />
                </mat-form-field>
              </div>
              <button class="saveCancel" mat-raised-button color="primary" (click)="saveEditedProfile()">
                Sačuvaj
              </button>
              <button class="saveCancel" mat-raised-button color="warn" (click)="cancelEditingProfile()">
                Otkaži
              </button>
            </form>
          </ng-container>
        </div>
      </div>
    </mat-tab>
    <mat-tab label="Lekari">
      <div class="divNasidoktori" *ngIf="!selectedDoctor">
        <h2 class="nasidoktori">Nasi doktori</h2>
      </div>
      <div class="searchSort" *ngIf="!selectedDoctor">
        <mat-icon>search</mat-icon>
        <mat-form-field class="search-bar">
          <input matInput placeholder="Pretraga po imenu, prezimenu, specijalizaciji ili ogranku"
            [(ngModel)]="searchText" (ngModelChange)="filterDoctors()" variant="filled" />
        </mat-form-field>
        <button mat-button [matMenuTriggerFor]="menu">
          <mat-icon>sort</mat-icon>
        </button>

        <mat-menu #menu="matMenu">
          <button mat-menu-item (click)="sortDoctors('first_name')">
            Po imenu
          </button>
          <button mat-menu-item (click)="sortDoctors('last_name')">
            Po prezimenu
          </button>
          <button mat-menu-item (click)="sortDoctors('specialization')">
            Po specijalizaciji
          </button>
          <button mat-menu-item (click)="sortDoctors('branch')">
            Po ogranku
          </button>
        </mat-menu>
      </div>
      <div class="doctors-container">
        <!-- JEDAN DOKTOR -->
        <div class="doctors-info" *ngIf="selectedDoctor; else doctorList">
          <div class="doctor-card-details">


            <div class="doctor-info">
              <p class="doctor-name">
                {{ selectedDoctor.first_name }} {{ selectedDoctor.last_name }}
              </p>
              <img [src]="selectedDoctor.profile_picture" alt="Profilna slika" />
              <p class="doctor-specialization">
                {{ selectedDoctor.specialization }}
              </p>
              <p>Ogranak: {{ selectedDoctor.branch }}</p>

            </div>
            <!-- PREGLEDI KOJE OMOGUCAVA LEKAR -->
            <div class="appointments">
              <table mat-table [dataSource]="selectedDoctor.appointments" class="mat-elevation-z8 demo-table">

                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>Pregled</th>
                  <td mat-cell *matCellDef="let appointment">
                    {{ appointment.name }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="duration">
                  <th mat-header-cell *matHeaderCellDef>Duzina pregleda (min)</th>
                  <td mat-cell *matCellDef="let appointment">
                    {{ appointment.duration }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="price">
                  <th mat-header-cell *matHeaderCellDef>Cena (RSD)</th>
                  <td mat-cell *matCellDef="let appointment">
                    {{ appointment.price }}
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="['name', 'duration', 'price']"></tr>
                <tr mat-row *matRowDef="
                    let appointment;
                    columns: ['name', 'duration', 'price']
                  "></tr>
              </table>
            </div>
            <!-- ZAKAZIVANJE PREGLEDA -->
            <div class="appointment-form">
              <h2>Zakazivanje pregleda</h2>
              <mat-form-field>
                <mat-label>Tip pregleda</mat-label>
                <mat-select [(ngModel)]="selectedAppointmentType">
                  <mat-option *ngFor="let a of selectedDoctor.appointments" [value]="a.name">{{ a.name }}</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field color="accent">
                <mat-label>Datum pregleda</mat-label>
                <input type="date" matInput [(ngModel)]="selectedDate" [min]="minDate" [max]="maxDate">
              </mat-form-field>

              <mat-form-field color="accent">
                <mat-label>Vreme pregleda</mat-label>
                <select matNativeControl [(ngModel)]="selectedHour">
                  <option *ngFor="let hour of hours" [value]="hour">{{ hour }}:00</option>
                </select>
              </mat-form-field>
              <p class="error-message" *ngIf="errorBook">{{ errorBook }}</p>
              <div class="buttons_book_back">
                <button mat-raised-button color="primary" (click)="scheduleAppointment()">
                  Zakazi pregled
                </button>
                <button mat-raised-button color="primary" (click)="clearSelectedDoctor()">
                  Nazad na sve lekare
                </button>
              </div>

            </div>
          </div>
        </div>

        <!-- Prikazivanje liste lekara -->
        <ng-template #doctorList>
          <ng-container *ngIf="doctorsToDisplay.length > 0; else noDoctors">
            <div *ngFor="let doctor of doctorsToDisplay" class="doctor-card" (click)="selectDoctor(doctor.username)">
              <img [src]="doctor.profile_picture" alt="Profilna slika" />
              <div class="doctor-info">
                <p>{{ doctor.first_name }} {{ doctor.last_name }}</p>
                <p>{{ doctor.specialization }}</p>
              </div>
            </div>
          </ng-container>
        </ng-template>
      </div>

      <ng-template #noDoctors>
        <p>No doctors to show</p>
      </ng-template>
    </mat-tab>
    <mat-tab label="Pregledi">Pregledi</mat-tab>
    <mat-tab label="Obavestenja">Obavestenja</mat-tab>
  </mat-tab-group>
</div>
